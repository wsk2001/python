 

backtrader 지원 지표 (bt.indicators 패키지)

 

 **- Indicator Reference** : https://www.backtrader.com/docu/indautoref/

 \- **커뮤니티**: https://community.backtrader.com/

 

- Accdecoscillator
- ATR
- Bollinger
- CCI
- Crossover
- Deviation
- DirectionalMove
- DMA
- EMA
- Ichimoku (일목균형표)
- MACD
- Momentum
- Sma: Simple Moving Average
- Stochastic
- Willams
- WMA

 

 

아래 샘플에서 차트를 표시하려면, matplotlib버전을 3.2.2 로 내려야 합니다. !!!

```
pip uninstall matplotlib
pip instaill matplotlib==3.3.2
```

 

```
import backtrader as bt
import yfinance as yf

class MyStrategy(bt.Strategy):
    def __init__(self):
        self.dataclose = self.datas[0].close
        self.order = None
        self.buyprice = None
        self.buycomm = None
        self.rsi = bt.indicators.RSI_SMA(self.data.close, period=21)

    def notify_order(self, order):
        if order.status in [order.Submitted, order.Accepted]:
            return
        if order.status in [order.Completed]:
            if order.isbuy():
                self.log(f'BUY  : 주가 {order.executed.price:,.0f}, '
                    f'수량 {order.executed.size:,.0f}, '
                    f'수수료 {order.executed.comm:,.0f}, '        
                    f'자산 {cerebro.broker.getvalue():,.0f}')
                self.buyprice = order.executed.price
                self.buycomm = order.executed.comm
            else:
                self.log(f'SELL : 주가 {order.executed.price:,.0f}, '
                    f'수량 {order.executed.size:,.0f}, '
                    f'수수료 {order.executed.comm:,.0f}, '
                    f'자산 {cerebro.broker.getvalue():,.0f}')
            self.bar_executed = len(self)
        elif order.status in [order.Canceled]:
            self.log('ORDER CANCELD')
        elif order.status in [order.Margin]:
            self.log('ORDER MARGIN')
        elif order.status in [order.Rejected]:
            self.log('ORDER REJECTED')
        self.order = None

    def next(self):
        if not self.position:
            if self.rsi < 30:
                self.order = self.buy()
        else:
            if self.rsi > 70:
                self.order = self.sell()

    def log(self, txt, dt=None):
        dt = self.datas[0].datetime.date(0)
        print(f'[{dt.isoformat()}] {txt}')

cerebro = bt.Cerebro()
cerebro.addstrategy(MyStrategy)
# data = bt.feeds.YahooFinanceData(dataname='036570.KS', fromdate=datetime(2017, 1, 1), todate=datetime(2019, 12, 1))
data = bt.feeds.PandasData(dataname=yf.download('036570.KS', '2018-01-01', '2021-12-01'))

cerebro.adddata(data)
cerebro.broker.setcash(10000000)
cerebro.broker.setcommission(commission=0.0014)
cerebro.addsizer(bt.sizers.PercentSizer, percents=90)

print(f'Initial Portfolio Value : {cerebro.broker.getvalue():,.0f} KRW')
cerebro.run()
print(f'Final Portfolio Value   : {cerebro.broker.getvalue():,.0f} KRW')
cerebro.plot(style='candlestick')
```

 

[*********************100%***********************] 1 of 1 completed
Initial Portfolio Value : 10,000,000 KRW
[2018-03-02] BUY : 주가 370,000, 수량 24, 수수료 12,432, 자산 10,083,568
[2018-04-02] SELL : 주가 425,000, 수량 -24, 수수료 14,280, 자산 11,293,288
[2018-04-25] BUY : 주가 358,000, 수량 28, 수수료 14,150, 자산 11,166,205
[2018-09-13] SELL : 주가 427,000, 수량 -28, 수수료 16,878, 자산 13,210,352
[2019-02-22] BUY : 주가 444,000, 수량 27, 수수료 16,645, 자산 12,832,207
[2019-03-29] SELL : 주가 498,000, 수량 -27, 수수료 18,669, 자산 14,621,035
[2019-06-04] BUY : 주가 467,500, 수량 28, 수수료 18,522, 자산 14,305,377
[2019-08-05] SELL : 주가 520,000, 수량 -28, 수수료 20,602, 자산 16,067,598
[2019-10-07] BUY : 주가 509,000, 수량 29, 수수료 20,365, 자산 16,104,390
[2020-01-03] SELL : 주가 547,000, 수량 -29, 수수료 21,886, 자산 17,111,339
[2020-03-20] BUY : 주가 559,000, 수량 29, 수수료 22,740, 자산 17,321,055
[2020-05-26] SELL : 주가 813,000, 수량 -29, 수수료 33,073, 자산 24,436,002
[2020-08-05] BUY : 주가 841,000, 수량 26, 수수료 30,607, 자산 24,535,374
[2020-12-14] SELL : 주가 896,000, 수량 -26, 수수료 32,609, 자산 25,802,552
[2021-03-30] BUY : 주가 834,000, 수량 28, 수수료 32,511, 자산 26,076,330
[2021-11-12] SELL : 주가 757,000, 수량 -28, 수수료 29,510, 자산 23,596,506
Final Portfolio Value  : 23,596,506 KRW

출처: https://lunadaddy.tistory.com/114 [하루y:티스토리]



---

https://dragon1-honey1-wayfarer.tistory.com/entry/Python-%EB%B0%B1%ED%8A%B8%EB%A0%88%EC%9D%B4%EB%8D%94Backtrader-%EB%A1%9C-Pandas-Dataframe-import-%ED%95%98%EA%B8%B0



안녕하세요.

백트레이더 (Backtrader) 로 Pandas Dataframe import 하는 과정을 소개해볼까 합니다.

 

이미 많은 분들이 다뤄 주셨지만, 그래도 제 글을 통해 부가적인 도움이 되었으면 합니다.

 

Backtrader 는 퀀트 투자의 백테스트 (일종의 시뮬레이션이라 생각하시면 되겠습니다.) 를 쉽게 해줄 수 있는 python

패키지입니다. 

 

내장된 메서드로 Yahoo finance 를 사용할 수 있지만, 국내 주식 정보의 경우 다소 부정확한 부분과 업데이트 속도에 있어 실제 트레이딩에 활용하긴 어렵습니다. 

 

그래서 개인 DB 를 가지고 있단 전제하에, 아래의 네이버 일간시세 2020-07-31 부터 2021-07-31 까지의 데이터 프레임을 백트레이더에 적용해보겠습니다. 

 

먼저 제가 가진 데이터 프레임의 유형입니다.

```
              code        date    open    high     low   close   diff   volume
date
2020-07-31  035420  2020-07-31  299000  303000  296500  301000   7000  1567503
2020-08-03  035420  2020-08-03  301500  314500  299000  314500  13500  1341104
2020-08-04  035420  2020-08-04  317500  322000  307500  311000   3500  1330818
2020-08-05  035420  2020-08-05  312000  314500  306500  313500   2500   809939
2020-08-06  035420  2020-08-06  313000  322000  310500  322000   8500  1032045
...            ...         ...     ...     ...     ...     ...    ...      ...
```



date 를 인덱스로 쓰고, 순서대로 종목코드, 날짜, 시가, 고가, 저가, 종가, 전일비, 거래량 입니다.

 

이제 이 데이터 프레임을 백트레이더에선 어떻게 처리하는지 확인이 필요합니다.

백트레이더는 pandafeed.py 란 파일에서 이를 처리하므로 해당 파일을 열어봅시다.

저의 경우, 경로는 아래와 같습니다. 

C:\Users\username\AppData\Local\Programs\Python\Python39\lib\site-packages\backtrader\feeds\pandafeed.py

 

(아니면, Visual Studio Code 같은 편집기를 사용하시는 경우, 코드 작성시 백트레이더를 import 하신 후 

data = bt.feeds.PandasData(dataname = df) 에서 PandasData에 커서를 올리고 ctrl+좌클릭 하셔도 됩니다.)

 

이렇게 pandafeed.py 를 열어서 136 번째 줄에 가면 아래와 같은 코드가 보입니다.



이 코드를 통해 백트레이더에서 어떻게 Pandas Dataframe 을 받고 있는지 알 수 있습니다. 

datetime 은 index 로 쓰고 있으므로 None, openinterest 는 사용하지 않을 것이므로 None 으로 바꿔줍시다.

 

그리고 159번째 줄을 보면 데이터필드가 어떻게 표출되는지 확인이 가능합니다. 

 

이제 원래의 코드로 돌아와서, 데이터프레임을 백트레이더가 알아듣게끔 가공하는 과정이 필요하겠죠.

(위의 데이터프레임 변수명은 df 입니다.)

 

``` py
# date 의 경우 str 타입이므로 datetime 형태로 자료변환을 하자
df['date'] = pd.to_datetime(df['date']) 
# date column 을 datetime 으로 명명하며, column 순서를 backtrader 가 보기 편하게 작성한다.
df.columns = ['code', 'datetime', 'open', 'high', 'low', 'close', 'diff', 'volume'] 
df.drop(['code', 'diff'], axis=1, inplace=True) # 이 중 맞지 않는 열은 삭제한다.
```


\1. date 칼럼은 datetime 형태로 자료형 변환을 하고

\2. 백트레이더가 요구하는 거에 맞게 데이터 이름을 바꾸며,

\3. 원래 데이터프레임이 가진 종목코드명과 전일비 칼럼을 삭제하여 백트레이더와 동일하게 칼럼수를 맞췄습니다.

 

이렇게 하면 개인 DB 의 데이터프레임 자료도 백트레이더에서 원활하게 사용 가능하실 것입니다.

 

이해를 돕기위해 예제 코드를 첨부합니다. 

(DB 관련 코드는 김황후 님의 '파이썬 증권데이터 분석' (2020) 을 참고했음을 말씀드립니다.)

``` py
from datetime import datetime, timedelta
import backtrader as bt
from backtrader import cerebro
from pandas.io.formats import style
import Analyzer
import pandas as pd

# RSI 가 40 미만이면 매수하고 60 초과이면 매도하는 전략
class MyStrategy(bt.Strategy):
    def __init__(self):
        self.rsi = bt.indicators.RSI(self.data.close)

    def next(self):
        if not self.position:
            if self.rsi < 40:
                self.order = self.buy()
        else:
            if self.rsi > 60:
                self.order = self.sell()

mk = Analyzer.MarketDB()
# DB에서 데이터를 불러온다.
df = mk.get_daily_price('NAVER', '2020-07-31', '2021-07-31') 
# date 의 경우 str 타입이므로 datetime 형태로 자료변환을 하자
df['date'] = pd.to_datetime(df['date']) 
# date column 을 datetime 으로 명명하며, column 순서를 backtrader 가 보기 편하게 작성한다.
df.columns = ['code', 'datetime', 'open', 'high', 'low', 'close', 'diff', 'volume'] 
df.drop(['code', 'diff'], axis=1, inplace=True) # 이 중 맞지 않는 열은 삭제한다. 

data = bt.feeds.PandasData(dataname=df) # Pandas Dataframe 입력
cerebro = bt.Cerebro() 
cerebro.adddata(data)
cerebro.addstrategy(MyStrategy)
cerebro.broker.setcash(10000000) # 초기 투자 자금 : 천만원
cerebro.addsizer(bt.sizers.SizerFix, stake=30) # 주식 매매단위: 30주.

cerebro.run() # Cerebro 클래스로 백테스트 실행
cerebro.plot(style='candlestick') # 백테스트 결과 차트 출력
```



이렇게 해서 되시는 분들도 있을 것이고, matplotlib 의 import warning error 가 나시는 분들도 있을 것입니다.

import warning 에러를 수정하는 방법은 그 다음 포스트에서 다뤄보겠습니다.